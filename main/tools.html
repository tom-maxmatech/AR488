<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="Appendixes" href="appendixes.html" /><link rel="prev" title="Building an AR488 GPIB Interface" href="building.html" />

    <meta name="generator" content="sphinx-4.5.0, furo 2021.11.16"/>
        <title>Working with EZGPIB and KE5FX - AR488 0.49.14 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=916d6ed8f59335acffa15474ff504849343d4c76" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=0af69da206d614734f649b27d4cdc2dd6c31f41d" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  body[data-theme="dark"] {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
  @media (prefers-color-scheme: dark) {
    body:not([data-theme="light"]) {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }
</style></head>
  <body>
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" />
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">AR488 0.49.14 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">AR488 0.49.14 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="commands.html">Command Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="building.html">Building an AR488 GPIB Interface</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Working with EZGPIB and KE5FX</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="appendixes.html">Appendixes</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../boards/gpib.html">GPIB IEEE-488 connector</a></li>
<li class="toctree-l2"><a class="reference internal" href="../boards/uno_nano.html">Arduino Uno and Nano</a></li>
<li class="toctree-l2"><a class="reference internal" href="../boards/mega2560.html">Arduino Mega 2560</a></li>
<li class="toctree-l2"><a class="reference internal" href="../boards/micro.html">Arduino Micro</a></li>
<li class="toctree-l2"><a class="reference internal" href="../boards/leonardo_r3.html">Arduino Leonardo R3</a></li>
<li class="toctree-l2"><a class="reference internal" href="xdiag.html">XDIAG command notes</a></li>
</ul>
</li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="working-with-ezgpib-and-ke5fx">
<h1>Working with EZGPIB and KE5FX<a class="headerlink" href="#working-with-ezgpib-and-ke5fx" title="Permalink to this headline">¶</a></h1>
<section id="ftdi-serial-vs-ch340g-serial">
<h2>FTDI serial vs CH340G serial<a class="headerlink" href="#ftdi-serial-vs-ch340g-serial" title="Permalink to this headline">¶</a></h2>
<p>EZGPIB is an IDE programming environment that can be used to work with GPIB devices.
<a class="reference external" href="http://www.ke5fx.com/gpib/readme.htm">KE5FX</a> provides testing tools that can be used
with various instruments that support GPIB. Both programs support the Prologix interface
and when communicating with it, both programs assert <code class="docutils literal notranslate"><span class="pre">RTS</span></code> and expect a <code class="docutils literal notranslate"><span class="pre">CTS</span></code>
response to confirm that the interface is ready to accept data.</p>
<p>The <a class="reference external" href="www.wch-ic.com/products/CH340.html">CH340G</a> chipset present in many Arduino
compatible boards does not respond with the <code class="docutils literal notranslate"><span class="pre">CTS</span></code> signal. There appear to be two
possible workarounds, one of which requires very good soldering skills. The <code class="docutils literal notranslate"><span class="pre">RTS</span></code> and
<code class="docutils literal notranslate"><span class="pre">CTS</span></code> signals are exposed via pins 14 and 9 respectively on the CH340G chip. While pin
9 connects to an easily accessible pad for soldering, pin 14 is not connected to
anywhere and because it is very small, attaching a wire to it is rather tricky. For this
reason, workaround 2 is easier to implement.</p>
<div class="admonition-disclaimer admonition">
<p class="admonition-title">Disclaimer</p>
<p>please proceed only if you are confident in your soldering skills. I take no
responsibility for damaged Arduino boards so if in doubt, ask a qualified or skilled
person for assistance.</p>
</div>
<section id="workaround-1">
<h3>Workaround 1<a class="headerlink" href="#workaround-1" title="Permalink to this headline">¶</a></h3>
<p>The workaround requires that pin 14 be connected to pin 9 on the CH340G chip. When
<code class="docutils literal notranslate"><span class="pre">RTS</span></code> is asserted by the host over USB, the signal is passed to the <code class="docutils literal notranslate"><span class="pre">RTS</span></code> output on
pin 14 of the CH340G. This signal would ordinarily be passed to a serial hardware device
which would respond by sending a response to the <code class="docutils literal notranslate"><span class="pre">CTS</span></code> input on pin 9 of the the
CH340G to indicate that it is ready to send. The workaround passes this signal back to
the <code class="docutils literal notranslate"><span class="pre">CTS</span></code> input via the link so that a <code class="docutils literal notranslate"><span class="pre">CTS</span></code> response will always be echoed back to
the host over USB. While this does not provide proper <code class="docutils literal notranslate"><span class="pre">RTS/CTS</span></code> handshaking, it does
allow the interface to respond with a <code class="docutils literal notranslate"><span class="pre">CTS</span></code> signal and, in turn, the host to be able
to accept responses to the commands sent to the interface, even when <code class="docutils literal notranslate"><span class="pre">RTS/CTS</span></code>
handshaking is used.</p>
</section>
<section id="workaround-2">
<h3>Workaround 2<a class="headerlink" href="#workaround-2" title="Permalink to this headline">¶</a></h3>
<p>Pin 9 of the CH340G needs to be connected to <code class="docutils literal notranslate"><span class="pre">GND</span></code>. This will keep <code class="docutils literal notranslate"><span class="pre">CTS</span></code> signal
asserted on the Arduino at all times, so again, proper handshaking is not provided.
Simply solder a short wire to the pad and connect to a convenient ground point.</p>
<p>A big thanks goes to Hartmut Päsler, who is currently looking after the EZGPIB program,
for informing me that the CH340G exposes the <code class="docutils literal notranslate"><span class="pre">RTS/CTS</span></code> signals via pins and that it
might be possible to make use of these pins to devise a solution.</p>
<p>Where Arduino boards are recognized as FTDI serial devices, the functionality is
embedded within the ATMEGA MEGA 16U2 chip. This chip does not expose the <code class="docutils literal notranslate"><span class="pre">RTS/CTS</span></code>
signals so this modification is not possible nor is it required to work with the KE5FX
toolkit. An Arduino board running with the 16U2 chip running AR488 will work fine with
the KE5FX GPIB toolkit, but for some reason, it is not recognized by the EZGPIB program.</p>
</section>
</section>
<section id="ezgpib-and-the-arduino-bootloader">
<h2>EZGPIB and the Arduino bootloader<a class="headerlink" href="#ezgpib-and-the-arduino-bootloader" title="Permalink to this headline">¶</a></h2>
<p>On older Arduino boards it was necessary to press the reset button to program the board.
This causes the board to reset and the bootloader to run. The bootloader will expect a
particular sequence of bytes within a timeout period and it will then expect a new
compiled sketch to be uploaded into memory. On completion of the upload, program control
is passed to the newly uploaded code. The timing of the upload is rather tricky and if
the timeout period expires or the upload is started too soon, then it will fail and the
board will start with the current program code.</p>
<p>Current versions of the board allow code to be uploaded via USB without having to use
the reset button. This is accomplished by triggering a reset of the board each time a
serial connection is opened. The bootloader is then re-loaded and if the required
sequence of bytes is received, and an upload of code proceeds automatically. When this
is finished, program execution passes to the new code as before.</p>
<p>The problem with this is that the bootloader is loaded every time that the serial port
is opened. This causes a delay of about 1 second before the compiled user program is
actually run and the interface is initialised. EZGPIB (and possibly other programs) that
do not re-try the connection attempt after waiting a second or so, fails to establish a
connection to the interface. Closing the program and immediately trying again usually
results in a successful connection.</p>
<p>The solution is to eliminate the delay caused by the board re-starting and the
bootloader being re- loaded into memory. This can be done quite easily by placing a 10μF
capacitor between the RST F capacitor between the RST and GND pins on the Arduino. This
causes the reset pulse, which is generated by activating the serial DTR signal, to be
drained to ground without affecting the RESET input on the AtMega328P processor. Since
it’s a capacitor, there is no direct DC coupling between RESET and GND. When the serial
port is now opened, the interface will just respond without the delay caused by
re-booting. Assuming the sequence “GPIB-USB” exists in the response to the ++ver
command, EZGPIB will now recognize it first time.</p>
<p>The drawback of this approach is that placing a capacitor permanently in this position
will prevent the Arduino IDE from being able to program the board. The reset button now
has to be used or a switch added to provide an on to run, off to program facility.</p>
<section id="hacking-the-ezgpib-binary">
<h3>Hacking the Ezgpib binary<a class="headerlink" href="#hacking-the-ezgpib-binary" title="Permalink to this headline">¶</a></h3>
<p>If you are familiar with using a hex editor, there is another approach that involves
editing the EZGPIB.EXE binary to prevent it looking for an RTS signal being asserted. If
the standard Windows USBSER.SYS driver is used, this never happens, so EZGPIB will never
find the GPIB adapter. This workaround involves changing a specific byte in the RTS
Check routine.</p>
<p>Open up a copy of EXGPIB.EXE version 20121217 in a hex editor. Look for the HEX
sequence:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">F6</span> <span class="mi">04</span> <span class="mi">24</span> <span class="mi">10</span> <span class="mi">74</span> <span class="mi">06</span>
</pre></div>
</div>
<p>Note that these instructions can also be found on <a class="reference external" href="http://www.dalton.ax/gpib/">http://www.dalton.ax/gpib/</a>, but show
the sequence as <code class="docutils literal notranslate"><span class="pre">F6</span> <span class="pre">02</span> <span class="pre">24</span> <span class="pre">10</span> <span class="pre">74</span> <span class="pre">06</span></code>. I found the sequence to be as above. I’m not sure
whether this is an error or because my binary is different from the one that the author
was working with. If you can’t find the sequence with <code class="docutils literal notranslate"><span class="pre">04</span></code> , check for the one with
<code class="docutils literal notranslate"><span class="pre">02</span></code>.</p>
<img alt="../_images/ezgpib_hex1.png" src="../_images/ezgpib_hex1.png"/>
<p>That sequence is the check for <code class="docutils literal notranslate"><span class="pre">RTS</span></code>. Change the penultimate byte to <code class="docutils literal notranslate"><span class="pre">75</span></code>, so that
the sequence now reads:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">F6</span> <span class="mi">04</span> <span class="mi">24</span> <span class="mi">10</span> <span class="mi">75</span> <span class="mi">06</span>
</pre></div>
</div>
<img alt="../_images/ezgpib_hex2.png" src="../_images/ezgpib_hex2.png"/>
<p>Now look for sequence:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">24</span> <span class="mi">04</span> <span class="mi">10</span> <span class="mi">0</span><span class="n">F</span> <span class="mi">95</span>
</pre></div>
</div>
<img alt="../_images/ezgpib_hex3.png" src="../_images/ezgpib_hex3.png"/>
<p>Change the last byte to <code class="docutils literal notranslate"><span class="pre">94</span></code> so that the sequence now reads:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">24</span> <span class="mi">04</span> <span class="mi">10</span> <span class="mi">0</span><span class="n">F</span> <span class="mi">94</span>
</pre></div>
</div>
<img alt="../_images/ezgpib_hex4.png" src="../_images/ezgpib_hex4.png"/>
<p>save the file and close the hex editor. EZGPIB should now find your adapter.</p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="appendixes.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Appendixes</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="building.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Building an AR488 GPIB Interface</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2022, John Chajecki |
          Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
          <a href="https://github.com/pradyunsg/furo">Furo theme</a>.
            | <a class="muted-link" href="../_sources/main/tools.rst.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Working with EZGPIB and KE5FX</a><ul>
<li><a class="reference internal" href="#ftdi-serial-vs-ch340g-serial">FTDI serial vs CH340G serial</a><ul>
<li><a class="reference internal" href="#workaround-1">Workaround 1</a></li>
<li><a class="reference internal" href="#workaround-2">Workaround 2</a></li>
</ul>
</li>
<li><a class="reference internal" href="#ezgpib-and-the-arduino-bootloader">EZGPIB and the Arduino bootloader</a><ul>
<li><a class="reference internal" href="#hacking-the-ezgpib-binary">Hacking the Ezgpib binary</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/furo.js"></script>
    </body>
</html>